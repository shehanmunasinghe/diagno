<!DOCTYPE html>
<html>

<head lang="en">
    <title>Diagno ❤️ | Human Lives Matter</title>

    <!--jQuery-->
    <script src="js/jquery-3.5.1.min.js"></script>

    <!--EpochJS-->
    <script src="js/d3.v3.min.js"></script>
    <script src="js/epoch.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/epoch.min.css">

    <!--Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <!-- Add icon library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Custom JS-->
    <script src="res/index.js"></script> 

    <!-- Custom CSS -->
    <link rel="stylesheet" type="text/css" href="res/index.css">
</head>

<!--Body-->

<body>

    <!--Navbar-->
    <nav class="navbar navbar-expand-sm navbar-dark bg-dark justify-content-between">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">

            <ul class="navbar-nav mr-auto">
                <button onclick="location.reload();" style="display:None" class="btn btn-dark screen_PlottingArea">
                    <i class="fa fa-home"></i>
                </button>
                <a class="navbar-brand" href="#">
                    Diagno</a>
            </ul>


            <ul class="navbar-nav mr-auto">
                <button onclick="analyze();" type="button" class="btn-sm btn-success screen_PlottingArea"
                    style="display:None">Analyse</button>
            </ul>

            <ul class="navbar-nav">
                <button onclick="openFullscreen();" class="btn btn-dark">
                    <span class="material-icons">fullscreen</span>
                </button>
            </ul>

        </div>
    </nav>

    <div class="container-fluid text-white">

        <div id="welcomeScreen" class="screen_WelcomeScreen">
            <div class="jumbotron bg-dark" style="margin-top:5px">

                <h1 class="display-3">
                    <center>Diagno ❤️</center>
                </h1>
                <h4 class="">
                    <center>AI Based Remote Cardiology Solution</center>
                </h4>
                <hr class="my-4" style="height: 1px; border-color:white; background-color:white">

                <p>
                    <center>
                        Diagno utilizes the power of deep learning to detect 5 different cardiac conditions with over
                        90% accuracy using just a 10-second recording of 12-Lead ECG.
                    </center>


                </p>
                <center>
                    <iframe title="vimeo-player" src="https://player.vimeo.com/video/451631301" width="640" height="360"
                        frameborder="0" allowfullscreen></iframe>
                </center>


                <hr class="my-4" style="height: 1px; border-color:white; background-color:white">



                <p class="">
                    Upload Recording
                    [<a href="https://github.com/shehanmunasinghe/diagno/blob/master/Test%20Instructions.md">Help/
                        Testing Instructions </a>]
                    [<a href="https://github.com/shehanmunasinghe/diagno/blob/master/Sample%20Recordings">Download
                        Sample Recordings </a>]


                </p>
                <div class="input-group">
                    <div class="custom-file">
                        <input type="file" class="custom-file-input" name="inputfile" id="inputfile"
                            aria-describedby="inputGroupFileAddon04">
                        <label class="custom-file-label" for="inputfile">Choose file</label>
                    </div>
                </div>

                <hr class="my-4" style="height: 1px; border-color:white; background-color:white">

                <div class="d-flex justify-content-around">
                    <a class="btn btn-primary btn" href="https://github.com/shehanmunasinghe/diagno" role="button">View
                        on GitHub</a>
                    <a class="btn btn-success btn" href="https://devpost.com/software/diagno" role="button">View on
                        Devpost</a>
                </div>


            </div>
        </div>


        <div style="padding:30px; display:None" id="plottingArea" class="screen_PlottingArea">
            <div class="row">
                <div class="col-*-*">
                    <p class="card-title">
                        <center>I</center>
                    </p>
                    <div id="lineChart_0" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>II</center>
                    </p>
                    <div id="lineChart_1" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>III</center>
                    </p>
                    <div id="lineChart_2" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>aVR</center>
                    </p>
                    <div id="lineChart_3" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>

                <div class="col-*-*">
                    <p class="card-title">
                        <center>aVL</center>
                    </p>
                    <div id="lineChart_4" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>aVF</center>
                    </p>
                    <div id="lineChart_5" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>V1</center>
                    </p>
                    <div id="lineChart_6" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>V2</center>
                    </p>
                    <div id="lineChart_7" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>

                <div class="col-*-*">
                    <p class="card-title">
                        <center>V3</center>
                    </p>
                    <div id="lineChart_8" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>V4</center>
                    </p>
                    <div id="lineChart_9" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>V5</center>
                    </p>
                    <div id="lineChart_10" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
                <div class="col-*-*">
                    <p class="card-title">
                        <center>V6</center>
                    </p>
                    <div id="lineChart_11" class="epoch" style="width: 300px; height: 150px; margin:10px"></div>
                </div>
            </div>

        </div>

    </div>

    <div id="resultDisplay" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Response</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="before-results">
                        <div class="loader">

                        </div>
                    </div>
                    <div class="error" style="display:None">
                        <p>Error Occured</p>
                    </div>
                    <table class="table table-sm after-results" style="display:None">
                        <tbody>
                            <tr id="LADr">
                                <td><a href="https://en.wikipedia.org/wiki/Left_axis_deviation#:~:text=In%20electrocardiography%2C%20left%20axis%20deviation,in%20leads%20aVF%20and%20II."
                                        target="_blank">Left Axis Deviation</a></td>
                                <td id="LAD"></td>
                                <td id="LADp"></td>
                            </tr>
                            <tr id="TAbr">
                                <td><a href="https://en.wikipedia.org/wiki/T_wave#Abnormalities" target="_blank">T Wave
                                        Abnormal</a></td>
                                <td id="TAb"></td>
                                <td id="TAbp"></td>
                            </tr>
                            <tr id="AFr">
                                <td><a href="https://www.mayoclinic.org/diseases-conditions/atrial-fibrillation/symptoms-causes/syc-20350624#:~:text=faster%20than%20normal.-,Atrial%20fibrillation%20is%20an%20irregular%20and%20often%20rapid%20heart%20rate,to%20175%20beats%20a%20minute."
                                        target="_blank">Atrial Fibrillation</a></td>
                                <td id="AF"></td>
                                <td id="AFp"></td>
                            </tr>
                            <tr id="STachr">
                                <td><a href="https://en.wikipedia.org/wiki/Sinus_tachycardia#:~:text=Sinus%20tachycardia%20(also%20colloquially%20known,beats%2Fmin%20(bpm)."
                                        target="_blank">Sinus Tachycardia</a></td>
                                <td id="STach"></td>
                                <td id="STachp"></td>
                            </tr>
                            <tr id="IAVBr">
                                <td><a href="https://www.ncbi.nlm.nih.gov/books/NBK448164/#:~:text=First%2Ddegree%20atrioventricular%20(AV),asymptomatic%20and%20without%20significant%20complications."
                                        target="_blank">1st Degree Av Block</a></td>
                                <td id="IAVB"></td>
                                <td id="IAVBp"></td>
                            </tr>
                        </tbody>
                    </table>
                    <p id="dataHere"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

</body>

<!--	JS-->
<script type="text/javascript">
    let _arr = []
    let formData;

    function formatArrayVals(arr) {
        var i;
        var vals = [];
        for (i = 0; i < Math.floor(arr.length / 4); i++) {
            vals.push({
                x: i,
                y: arr[i]
            })
        }
        return vals;
    }


    document.getElementById('inputfile')
        .addEventListener('change', function () {

            var fr = new FileReader();
            fr.onload = function () {

                var j_arr = JSON.parse(fr.result);
                _arr = j_arr;
                formData = fr;

                var myChart_1 = $('#lineChart_0').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[0]),
                    }],
                    axes: ['bottom']
                });

                var myChart_1 = $('#lineChart_1').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[1]),
                    }],
                    axes: ['bottom']
                });

                var myChart_2 = $('#lineChart_2').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[2])
                    }],
                    axes: ['bottom']
                });

                var myChart_3 = $('#lineChart_3').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[3])
                    }],
                    axes: ['bottom']
                });

                var myChart_1 = $('#lineChart_4').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[4]),
                    }],
                    axes: ['bottom']
                });

                var myChart_1 = $('#lineChart_5').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[5]),
                    }],
                    axes: ['bottom']
                });

                var myChart_2 = $('#lineChart_6').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[6])
                    }],
                    axes: ['bottom']
                });

                var myChart_3 = $('#lineChart_7').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[7])
                    }],
                    axes: ['bottom']
                });


                var myChart_1 = $('#lineChart_8').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[8]),
                    }],
                    axes: ['bottom']
                });

                var myChart_1 = $('#lineChart_9').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[9]),
                    }],
                    axes: ['bottom']
                });

                var myChart_2 = $('#lineChart_10').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[10])
                    }],
                    axes: ['bottom']
                });

                var myChart_3 = $('#lineChart_11').epoch({
                    type: 'line',
                    data: [{
                        values: formatArrayVals(j_arr[11])
                    }],
                    axes: ['bottom']
                });
                $(".screen_PlottingArea").show();

                $(".screen_WelcomeScreen").hide();
            }

            fr.readAsText(this.files[0]);
        })


    $(document).ready(function () {
        renderHome();
    });

    function analyze() {
        $('#resultDisplay').modal('show')
        var myHeaders = new Headers();

        myHeaders.append("Content-Type", "application/x-www-form-urlencoded");

        var urlencoded = new URLSearchParams();
        urlencoded.append("inputFile", JSON.stringify(_arr));

        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: urlencoded,
            redirect: 'follow'
        };

        fetch("https://www.diagno.ml:8443/predictions/torch_model", requestOptions)
            .then(response => response.json())
            .then((result) => {

                $(".after-results").show();
                $(".before-results").hide();
                
                $('#LAD').text(`${(result[0] * 100).toFixed(2)}%`);
                $('#TAb').text(`${(result[1] * 100).toFixed(2)}%`);
                $('#AF').text(`${(result[2] * 100).toFixed(2)}%`);
                $('#STach').text(`${(result[3] * 100).toFixed(2)}%`);
                $('#IAVB').text(`${(result[4] * 100).toFixed(2)}%`);

                if (result[0] > 0.5) {
                    $('#LADr').addClass("table-danger");
                    $('#LADp').text("HIGH RISK");
                    $('#LADp').addClass("danger-text");
                } else {
                    $('#LADr').addClass("table-success");
                    $('#LADp').text("LOW RISK");
                    $('#LADp').addClass("success-text");
                }

                if (result[1] > 0.5) {
                    $('#TAbr').addClass("table-danger");
                    $('#TAbp').text("HIGH RISK");
                    $('#TAbp').addClass("danger-text");
                } else {
                    $('#TAbr').addClass("table-success");
                    $('#TAbp').text("LOW RISK");
                    $('#TAbp').addClass("success-text");
                }

                if (result[2] > 0.5) {
                    $('#AFr').addClass("table-danger");
                    $('#AFp').text("HIGH RISK");
                    $('#AFp').addClass("danger-text");
                } else {
                    $('#AFr').addClass("table-success");
                    $('#AFp').text("LOW RISK");
                    $('#AFp').addClass("success-text");
                }

                if (result[3] > 0.5) {
                    $('#STachr').addClass("table-danger");
                    $('#STachp').text("HIGH RISK");
                    $('#STachp').addClass("danger-text");
                } else {
                    $('#STachr').addClass("table-success");
                    $('#STachp').text("LOW RISK");
                    $('#STachp').addClass("success-text");
                }

                if (result[4] > 0.5) {
                    $('#IAVBr').addClass("table-danger");
                    $('#IAVBp').text("HIGH RISK");
                    $('#IAVBp').addClass("danger-text");
                } else {
                    $('#IAVBr').addClass("table-success");
                    $('#IAVBp').text("LOW RISK");
                    $('#IAVBp').addClass("success-text");
                }
            })
            .catch(error => {
                // console.log('error', error)
                $(".error").show();
                $(".before-results").hide();
            });
    }

</script>

<!--WebSocket-->
<script>

    $("#wsConnectBtn").click(function () {
        //  alert("The paragraph was clicked.");
        //    alert($("#wsAddress").val())
        renderRealTimePlotPage();

        ws = new WebSocket("ws://127.0.0.1:5678/")
        ws.onopen = function (msg) {
            // Logic for opened connection
            console.log('Connected');
        };
        ws.onmessage = function (msg) {
            // Handle received data
            vals = JSON.parse(msg.data)
            console.log(vals);
        };

        ws.onclose = function (msg) {
            // Logic for closed connection
            console.log('Disconnected');
        }
        ws.error = function (err) {
            console.log(err); // Write errors to console
        }
    });

</script>



</html>